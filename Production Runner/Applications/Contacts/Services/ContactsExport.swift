//
//  ContactsExport.swift
//  Production Runner
//
//  Created by Claude on 11/3/25.
//  Contacts generate PDF
//

import SwiftUI
import PDFKit

#if os(macOS)
import AppKit
#else
import UIKit
#endif

struct ContactsExport {
    
    static func generatePDF(contacts: [Contact], filterTitle: String, projectName: String = "Production") -> URL? {
        let pageWidth: CGFloat = 612 // 8.5 inches
        let pageHeight: CGFloat = 792 // 11 inches
        let pageRect = CGRect(x: 0, y: 0, width: pageWidth, height: pageHeight)
        
        let tempURL = FileManager.default.temporaryDirectory
            .appendingPathComponent("Contacts_Export_\(UUID().uuidString).pdf")
        
        #if os(macOS)
        return generatePDFMacOS(contacts: contacts, filterTitle: filterTitle, projectName: projectName, pageRect: pageRect, url: tempURL)
        #else
        return generatePDFiOS(contacts: contacts, filterTitle: filterTitle, projectName: projectName, pageRect: pageRect, url: tempURL)
        #endif
    }
    
    #if os(macOS)
    private static func generatePDFMacOS(contacts: [Contact], filterTitle: String, projectName: String, pageRect: CGRect, url: URL) -> URL? {
        
        var mediaBox = pageRect
        
        guard let pdfContext = CGContext(url as CFURL, mediaBox: &mediaBox, [
            kCGPDFContextTitle: "\(projectName) - Contacts",
            kCGPDFContextCreator: "Production Runner"
        ] as CFDictionary) else {
            return nil
        }
        
        pdfContext.beginPDFPage(nil)
        
        // Create NSGraphicsContext without flipping - use natural PDF coordinates (bottom-left origin)
        let nsContext = NSGraphicsContext(cgContext: pdfContext, flipped: false)
        NSGraphicsContext.current = nsContext
        
        let margins: CGFloat = 50
        let contentWidth = pageRect.width - (margins * 2)
        let pageBottom: CGFloat = 50  // Don't draw below this point
        var currentY: CGFloat = pageRect.height - margins  // Start from top in bottom-up coordinates
        
        // Group contacts
        let castContacts = contacts.filter { $0.category == .cast }.sorted { $0.name < $1.name }
        let crewContacts = contacts.filter { $0.category == .crew }.sorted { $0.name < $1.name }
        let vendorContacts = contacts.filter { $0.category == .vendor }.sorted { $0.name < $1.name }
        
        // Header
        currentY = drawHeaderMacOS(
            projectName: projectName,
            filterTitle: filterTitle,
            castCount: castContacts.count,
            crewCount: crewContacts.count,
            vendorCount: vendorContacts.count,
            x: margins,
            y: currentY,
            width: contentWidth
        )
        
        currentY -= 30  // Move down
        
        // Draw sections with pagination
        if !castContacts.isEmpty {
            currentY = drawSectionWithPaginationMacOS(
                category: .cast,
                contacts: castContacts,
                projectName: projectName,
                filterTitle: filterTitle,
                castCount: castContacts.count,
                crewCount: crewContacts.count,
                vendorCount: vendorContacts.count,
                x: margins,
                y: currentY,
                width: contentWidth,
                pageBottom: pageBottom,
                pageRect: pageRect,
                pdfContext: pdfContext
            )
        }
        
        if !crewContacts.isEmpty {
            currentY = drawSectionWithPaginationMacOS(
                category: .crew,
                contacts: crewContacts,
                projectName: projectName,
                filterTitle: filterTitle,
                castCount: castContacts.count,
                crewCount: crewContacts.count,
                vendorCount: vendorContacts.count,
                x: margins,
                y: currentY,
                width: contentWidth,
                pageBottom: pageBottom,
                pageRect: pageRect,
                pdfContext: pdfContext
            )
        }
        
        if !vendorContacts.isEmpty {
            currentY = drawSectionWithPaginationMacOS(
                category: .vendor,
                contacts: vendorContacts,
                projectName: projectName,
                filterTitle: filterTitle,
                castCount: castContacts.count,
                crewCount: crewContacts.count,
                vendorCount: vendorContacts.count,
                x: margins,
                y: currentY,
                width: contentWidth,
                pageBottom: pageBottom,
                pageRect: pageRect,
                pdfContext: pdfContext
            )
        }
        
        // Footer (at bottom of page)
        let footerText = "Generated by Production Runner"
        let footerAttrs: [NSAttributedString.Key: Any] = [
            .font: NSFont.systemFont(ofSize: 9),
            .foregroundColor: NSColor.gray
        ]
        let footerSize = footerText.size(withAttributes: footerAttrs)
        let footerX = (pageRect.width - footerSize.width) / 2
        let footerY: CGFloat = 30  // 30 points from bottom in bottom-up coords
        footerText.draw(at: CGPoint(x: footerX, y: footerY), withAttributes: footerAttrs)
        
        NSGraphicsContext.current = nil
        
        pdfContext.endPDFPage()
        pdfContext.closePDF()
        
        return url
    }
    #endif
    
    #if os(iOS)
    private static func generatePDFiOS(contacts: [Contact], filterTitle: String, projectName: String, pageRect: CGRect, url: URL) -> URL? {
        
        let renderer = UIGraphicsPDFRenderer(bounds: pageRect)
        
        let data = renderer.pdfData { ctx in
            let margins: CGFloat = 50
            let contentWidth = pageRect.width - (margins * 2)
            let pageBottom: CGFloat = 50  // Don't draw below this point
            
            // Start first page
            ctx.beginPage()
            var currentY: CGFloat = margins
            
            // Group contacts
            let castContacts = contacts.filter { $0.category == .cast }.sorted { $0.name < $1.name }
            let crewContacts = contacts.filter { $0.category == .crew }.sorted { $0.name < $1.name }
            let vendorContacts = contacts.filter { $0.category == .vendor }.sorted { $0.name < $1.name }
            
            // Header
            currentY = drawHeaderiOS(
                projectName: projectName,
                filterTitle: filterTitle,
                castCount: castContacts.count,
                crewCount: crewContacts.count,
                vendorCount: vendorContacts.count,
                x: margins,
                y: currentY,
                width: contentWidth
            )
            
            currentY += 30
            
            // Draw sections with pagination
            if !castContacts.isEmpty {
                currentY = drawSectionWithPaginationiOS(
                    ctx: ctx,
                    category: .cast,
                    contacts: castContacts,
                    projectName: projectName,
                    filterTitle: filterTitle,
                    castCount: castContacts.count,
                    crewCount: crewContacts.count,
                    vendorCount: vendorContacts.count,
                    x: margins,
                    y: currentY,
                    width: contentWidth,
                    pageBottom: pageRect.height - pageBottom,
                    pageRect: pageRect
                )
            }
            
            if !crewContacts.isEmpty {
                currentY = drawSectionWithPaginationiOS(
                    ctx: ctx,
                    category: .crew,
                    contacts: crewContacts,
                    projectName: projectName,
                    filterTitle: filterTitle,
                    castCount: castContacts.count,
                    crewCount: crewContacts.count,
                    vendorCount: vendorContacts.count,
                    x: margins,
                    y: currentY,
                    width: contentWidth,
                    pageBottom: pageRect.height - pageBottom,
                    pageRect: pageRect
                )
            }
            
            if !vendorContacts.isEmpty {
                currentY = drawSectionWithPaginationiOS(
                    ctx: ctx,
                    category: .vendor,
                    contacts: vendorContacts,
                    projectName: projectName,
                    filterTitle: filterTitle,
                    castCount: castContacts.count,
                    crewCount: crewContacts.count,
                    vendorCount: vendorContacts.count,
                    x: margins,
                    y: currentY,
                    width: contentWidth,
                    pageBottom: pageRect.height - pageBottom,
                    pageRect: pageRect
                )
            }
            
            // Footer
            let footerText = "Generated by Production Runner"
            let footerAttrs: [NSAttributedString.Key: Any] = [
                .font: UIFont.systemFont(ofSize: 9),
                .foregroundColor: UIColor.gray
            ]
            let footerSize = footerText.size(withAttributes: footerAttrs)
            let footerX = (pageRect.width - footerSize.width) / 2
            footerText.draw(at: CGPoint(x: footerX, y: pageRect.height - 30), withAttributes: footerAttrs)
        }
        
        do {
            try data.write(to: url)
            return url
        } catch {
            print("Error writing PDF: \(error)")
            return nil
        }
    }
    #endif
    
    // MARK: - macOS Drawing Functions
    #if os(macOS)
    private static func drawSectionWithPaginationMacOS(
        category: Contact.Category,
        contacts: [Contact],
        projectName: String,
        filterTitle: String,
        castCount: Int,
        crewCount: Int,
        vendorCount: Int,
        x: CGFloat,
        y: CGFloat,
        width: CGFloat,
        pageBottom: CGFloat,
        pageRect: CGRect,
        pdfContext: CGContext
    ) -> CGFloat {
        var currentY = y
        let margins: CGFloat = 50
        
        // Check if we need a new page for the section header
        if currentY - 50 < pageBottom {
            NSGraphicsContext.current = nil
            pdfContext.endPDFPage()
            pdfContext.beginPDFPage(nil)
            let nsContext = NSGraphicsContext(cgContext: pdfContext, flipped: false)
            NSGraphicsContext.current = nsContext
            
            currentY = pageRect.height - margins
            currentY = drawHeaderMacOS(
                projectName: projectName,
                filterTitle: filterTitle,
                castCount: castCount,
                crewCount: crewCount,
                vendorCount: vendorCount,
                x: margins,
                y: currentY,
                width: width
            )
            currentY -= 30
        }
        
        // Category color and icon
        let categoryColor: NSColor
        let icon: String
        
        switch category {
        case .cast:
            categoryColor = NSColor(red: 1.0, green: 0.23, blue: 0.19, alpha: 1.0)
            icon = "‚òÖ"
        case .crew:
            categoryColor = NSColor(red: 0.0, green: 0.48, blue: 1.0, alpha: 1.0)
            icon = "‚óè"
        case .vendor:
            categoryColor = NSColor(red: 0.2, green: 0.78, blue: 0.35, alpha: 1.0)
            icon = "‚ñ†"
        }
        
        // Header
        let headerText = "\(icon)  \(category.displayName.uppercased()) (\(contacts.count))"
        let headerAttrs: [NSAttributedString.Key: Any] = [
            .font: NSFont.boldSystemFont(ofSize: 14),
            .foregroundColor: categoryColor
        ]
        
        headerText.draw(at: CGPoint(x: x, y: currentY), withAttributes: headerAttrs)
        currentY -= 22  // Move down
        
        // Line
        let linePath = NSBezierPath()
        linePath.move(to: CGPoint(x: x, y: currentY))
        linePath.line(to: CGPoint(x: x + width, y: currentY))
        categoryColor.setStroke()
        linePath.lineWidth = 2
        linePath.stroke()
        currentY -= 12  // Move down
        
        // Draw each contact
        for contact in contacts {
            // Calculate card height to check if we need a new page
            var lines = 2
            if !contact.phone.isEmpty { lines += 1 }
            if !contact.email.isEmpty { lines += 1 }
            let cardHeight = CGFloat(lines) * 18 + (14 * 2)
            
            // Check if we need a new page
            if currentY - cardHeight - 12 < pageBottom {
                NSGraphicsContext.current = nil
                pdfContext.endPDFPage()
                pdfContext.beginPDFPage(nil)
                let nsContext = NSGraphicsContext(cgContext: pdfContext, flipped: false)
                NSGraphicsContext.current = nsContext
                
                currentY = pageRect.height - margins
                currentY = drawHeaderMacOS(
                    projectName: projectName,
                    filterTitle: filterTitle,
                    castCount: castCount,
                    crewCount: crewCount,
                    vendorCount: vendorCount,
                    x: margins,
                    y: currentY,
                    width: width
                )
                currentY -= 30
            }
            
            currentY = drawContactCardMacOS(contact: contact, categoryColor: categoryColor, x: x, y: currentY, width: width)
            currentY -= 12  // Space between cards
        }
        
        currentY -= 25  // Space between sections
        
        return currentY
    }
    
    private static func drawHeaderMacOS(
        projectName: String,
        filterTitle: String,
        castCount: Int,
        crewCount: Int,
        vendorCount: Int,
        x: CGFloat,
        y: CGFloat,
        width: CGFloat
    ) -> CGFloat {
        // Note: y starts from the top in our coordinate system
        // In PDF natural coords, we need to flip: Y = pageHeight - logicalY
        var currentY = y
        
        // Title
        let title = "\(projectName) - Contacts"
        let titleAttrs: [NSAttributedString.Key: Any] = [
            .font: NSFont.boldSystemFont(ofSize: 24),
            .foregroundColor: NSColor.black
        ]
        
        title.draw(at: CGPoint(x: x, y: currentY), withAttributes: titleAttrs)
        currentY -= 32  // Move down (subtract in bottom-up coords)
        
        // Subtitle
        let subtitle = filterTitle == "All" ? "All Contacts" : "\(filterTitle) Contacts"
        let subtitleAttrs: [NSAttributedString.Key: Any] = [
            .font: NSFont.systemFont(ofSize: 14, weight: .semibold),
            .foregroundColor: NSColor.darkGray
        ]
        
        subtitle.draw(at: CGPoint(x: x, y: currentY), withAttributes: subtitleAttrs)
        currentY -= 22  // Move down
        
        // Date and stats
        let dateFormatter = DateFormatter()
        dateFormatter.dateStyle = .medium
        let totalCount = castCount + crewCount + vendorCount
        let infoText = "\(dateFormatter.string(from: Date())) ‚Ä¢ Total: \(totalCount) ‚Ä¢ Cast: \(castCount) ‚Ä¢ Crew: \(crewCount) ‚Ä¢ Vendors: \(vendorCount)"
        
        let infoAttrs: [NSAttributedString.Key: Any] = [
            .font: NSFont.systemFont(ofSize: 10),
            .foregroundColor: NSColor.gray
        ]
        
        infoText.draw(at: CGPoint(x: x, y: currentY), withAttributes: infoAttrs)
        currentY -= 20  // Move down
        
        // Line
        let linePath = NSBezierPath()
        linePath.move(to: CGPoint(x: x, y: currentY))
        linePath.line(to: CGPoint(x: x + width, y: currentY))
        NSColor.lightGray.setStroke()
        linePath.lineWidth = 1
        linePath.stroke()
        currentY -= 5  // Move down
        
        return currentY
    }

    
    private static func drawContactCardMacOS(
        contact: Contact,
        categoryColor: NSColor,
        x: CGFloat,
        y: CGFloat,
        width: CGFloat
    ) -> CGFloat {
        let padding: CGFloat = 14
        let lineHeight: CGFloat = 18
        
        // Calculate height
        var lines = 2
        if !contact.phone.isEmpty { lines += 1 }
        if !contact.email.isEmpty { lines += 1 }
        
        let cardHeight = CGFloat(lines) * lineHeight + (padding * 2)
        
        // Card starts at currentY and extends downward (in bottom-up coords, that means Y goes down)
        let cardBottom = y - cardHeight
        
        // Draw card background
        NSColor(white: 0.97, alpha: 1.0).setFill()
        NSRect(x: x, y: cardBottom, width: width, height: cardHeight).fill()
        
        // Accent bar on left
        categoryColor.setFill()
        NSRect(x: x, y: cardBottom, width: 4, height: cardHeight).fill()
        
        // Border
        let borderPath = NSBezierPath(rect: NSRect(x: x, y: cardBottom, width: width, height: cardHeight))
        categoryColor.withAlphaComponent(0.3).setStroke()
        borderPath.lineWidth = 1
        borderPath.stroke()
        
        let contentX = x + padding + 6
        let totalTextHeight = CGFloat(lines) * lineHeight
        let topPadding = (cardHeight - totalTextHeight) / 2 + 4  // Add 4pt offset for better centering
        var contentY = y - topPadding  // Start centered
        
        // Name
        let nameText = "[\(contact.category.displayName.uppercased())] \(contact.name)"
        let nameAttrs: [NSAttributedString.Key: Any] = [
            .font: NSFont.boldSystemFont(ofSize: 13),
            .foregroundColor: NSColor.black
        ]
        
        nameText.draw(at: CGPoint(x: contentX, y: contentY), withAttributes: nameAttrs)
        contentY -= lineHeight
        
        // Detail attributes
        let detailAttrs: [NSAttributedString.Key: Any] = [
            .font: NSFont.systemFont(ofSize: 11),
            .foregroundColor: NSColor.darkGray
        ]
        
        // Dept/role
        var deptRole = contact.department.displayName
        if !contact.role.isEmpty {
            deptRole += " ‚Ä¢ \(contact.role)"
        }
        deptRole.draw(at: CGPoint(x: contentX, y: contentY), withAttributes: detailAttrs)
        contentY -= lineHeight
        
        // Phone
        if !contact.phone.isEmpty {
            "üìû \(contact.phone)".draw(at: CGPoint(x: contentX, y: contentY), withAttributes: detailAttrs)
            contentY -= lineHeight
        }
        
        // Email
        if !contact.email.isEmpty {
            "‚úâÔ∏è \(contact.email)".draw(at: CGPoint(x: contentX, y: contentY), withAttributes: detailAttrs)
        }
        
        return cardBottom  // Return the bottom of the card for next item
    }
    #endif
    
    // MARK: - iOS Drawing Functions
    #if os(iOS)
    private static func drawSectionWithPaginationiOS(
        ctx: UIGraphicsPDFRendererContext,
        category: Contact.Category,
        contacts: [Contact],
        projectName: String,
        filterTitle: String,
        castCount: Int,
        crewCount: Int,
        vendorCount: Int,
        x: CGFloat,
        y: CGFloat,
        width: CGFloat,
        pageBottom: CGFloat,
        pageRect: CGRect
    ) -> CGFloat {
        var currentY = y
        let margins: CGFloat = 50
        
        // Check if we need a new page for the section header
        if currentY + 50 > pageBottom {
            ctx.beginPage()
            currentY = margins
            currentY = drawHeaderiOS(
                projectName: projectName,
                filterTitle: filterTitle,
                castCount: castCount,
                crewCount: crewCount,
                vendorCount: vendorCount,
                x: margins,
                y: currentY,
                width: width
            )
            currentY += 30
        }
        
        // Category color and icon
        let categoryColor: UIColor
        let icon: String
        
        switch category {
        case .cast:
            categoryColor = UIColor(red: 1.0, green: 0.23, blue: 0.19, alpha: 1.0)
            icon = "‚òÖ"
        case .crew:
            categoryColor = UIColor(red: 0.0, green: 0.48, blue: 1.0, alpha: 1.0)
            icon = "‚óè"
        case .vendor:
            categoryColor = UIColor(red: 0.2, green: 0.78, blue: 0.35, alpha: 1.0)
            icon = "‚ñ†"
        }
        
        // Header
        let headerText = "\(icon)  \(category.displayName.uppercased()) (\(contacts.count))"
        let headerAttrs: [NSAttributedString.Key: Any] = [
            .font: UIFont.boldSystemFont(ofSize: 14),
            .foregroundColor: categoryColor
        ]
        
        headerText.draw(at: CGPoint(x: x, y: currentY), withAttributes: headerAttrs)
        currentY += 22
        
        // Line
        let path = UIBezierPath()
        path.move(to: CGPoint(x: x, y: currentY))
        path.addLine(to: CGPoint(x: x + width, y: currentY))
        categoryColor.setStroke()
        path.lineWidth = 2
        path.stroke()
        currentY += 12
        
        // Draw each contact
        for contact in contacts {
            // Calculate card height to check if we need a new page
            var lines = 2
            if !contact.phone.isEmpty { lines += 1 }
            if !contact.email.isEmpty { lines += 1 }
            let cardHeight = CGFloat(lines) * 18 + (14 * 2)
            
            // Check if we need a new page
            if currentY + cardHeight + 12 > pageBottom {
                ctx.beginPage()
                currentY = margins
                currentY = drawHeaderiOS(
                    projectName: projectName,
                    filterTitle: filterTitle,
                    castCount: castCount,
                    crewCount: crewCount,
                    vendorCount: vendorCount,
                    x: margins,
                    y: currentY,
                    width: width
                )
                currentY += 30
            }
            
            currentY = drawContactCardiOS(contact: contact, categoryColor: categoryColor, x: x, y: currentY, width: width)
            currentY += 12
        }
        
        currentY += 25
        
        return currentY
    }
    
    private static func drawHeaderiOS(
        projectName: String,
        filterTitle: String,
        castCount: Int,
        crewCount: Int,
        vendorCount: Int,
        x: CGFloat,
        y: CGFloat,
        width: CGFloat
    ) -> CGFloat {
        var currentY = y
        
        // Title
        let title = "\(projectName) - Contacts"
        let titleAttrs: [NSAttributedString.Key: Any] = [
            .font: UIFont.boldSystemFont(ofSize: 24),
            .foregroundColor: UIColor.black
        ]
        
        title.draw(at: CGPoint(x: x, y: currentY), withAttributes: titleAttrs)
        currentY += 32
        
        // Subtitle
        let subtitle = filterTitle == "All" ? "All Contacts" : "\(filterTitle) Contacts"
        let subtitleAttrs: [NSAttributedString.Key: Any] = [
            .font: UIFont.systemFont(ofSize: 14, weight: .semibold),
            .foregroundColor: UIColor.darkGray
        ]
        
        subtitle.draw(at: CGPoint(x: x, y: currentY), withAttributes: subtitleAttrs)
        currentY += 22
        
        // Date and stats
        let dateFormatter = DateFormatter()
        dateFormatter.dateStyle = .medium
        let totalCount = castCount + crewCount + vendorCount
        let infoText = "\(dateFormatter.string(from: Date())) ‚Ä¢ Total: \(totalCount) ‚Ä¢ Cast: \(castCount) ‚Ä¢ Crew: \(crewCount) ‚Ä¢ Vendors: \(vendorCount)"
        
        let infoAttrs: [NSAttributedString.Key: Any] = [
            .font: UIFont.systemFont(ofSize: 10),
            .foregroundColor: UIColor.gray
        ]
        
        infoText.draw(at: CGPoint(x: x, y: currentY), withAttributes: infoAttrs)
        currentY += 20
        
        // Line
        let path = UIBezierPath()
        path.move(to: CGPoint(x: x, y: currentY))
        path.addLine(to: CGPoint(x: x + width, y: currentY))
        UIColor.lightGray.setStroke()
        path.lineWidth = 1
        path.stroke()
        currentY += 5
        
        return currentY
    }

    
    private static func drawContactCardiOS(
        contact: Contact,
        categoryColor: UIColor,
        x: CGFloat,
        y: CGFloat,
        width: CGFloat
    ) -> CGFloat {
        let padding: CGFloat = 14
        let lineHeight: CGFloat = 18
        
        // Calculate height
        var lines = 2
        if !contact.phone.isEmpty { lines += 1 }
        if !contact.email.isEmpty { lines += 1 }
        
        let cardHeight = CGFloat(lines) * lineHeight + (padding * 2)
        
        // Draw card background
        UIColor(white: 0.97, alpha: 1.0).setFill()
        UIRectFill(CGRect(x: x, y: y, width: width, height: cardHeight))
        
        // Accent bar
        categoryColor.setFill()
        UIRectFill(CGRect(x: x, y: y, width: 4, height: cardHeight))
        
        // Border
        let borderPath = UIBezierPath(rect: CGRect(x: x, y: y, width: width, height: cardHeight))
        categoryColor.withAlphaComponent(0.3).setStroke()
        borderPath.lineWidth = 1
        borderPath.stroke()
        
        let contentX = x + padding + 6
        let totalTextHeight = CGFloat(lines) * lineHeight
        let topPadding = (cardHeight - totalTextHeight) / 2 + 4  // Add 4pt offset for better centering
        var contentY = y + topPadding  // Start centered
        
        // Name
        let nameText = "[\(contact.category.displayName.uppercased())] \(contact.name)"
        let nameAttrs: [NSAttributedString.Key: Any] = [
            .font: UIFont.boldSystemFont(ofSize: 13),
            .foregroundColor: UIColor.black
        ]
        
        nameText.draw(at: CGPoint(x: contentX, y: contentY), withAttributes: nameAttrs)
        contentY += lineHeight
        
        // Detail attributes
        let detailAttrs: [NSAttributedString.Key: Any] = [
            .font: UIFont.systemFont(ofSize: 11),
            .foregroundColor: UIColor.darkGray
        ]
        
        // Dept/role
        var deptRole = contact.department.displayName
        if !contact.role.isEmpty {
            deptRole += " ‚Ä¢ \(contact.role)"
        }
        deptRole.draw(at: CGPoint(x: contentX, y: contentY), withAttributes: detailAttrs)
        contentY += lineHeight
        
        // Phone
        if !contact.phone.isEmpty {
            "üìû \(contact.phone)".draw(at: CGPoint(x: contentX, y: contentY), withAttributes: detailAttrs)
            contentY += lineHeight
        }
        
        // Email
        if !contact.email.isEmpty {
            "‚úâÔ∏è \(contact.email)".draw(at: CGPoint(x: contentX, y: contentY), withAttributes: detailAttrs)
        }
        
        return y + cardHeight
    }
    #endif
}
